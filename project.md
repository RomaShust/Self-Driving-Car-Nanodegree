

```python
import numpy as np
import keras
import matplotlib.pyplot as plt
import csv
import cv2
import random
from sklearn.model_selection import train_test_split
from sklearn.utils import shuffle
from keras.models import *
from keras.layers import *
from keras.optimizers import Adam
%matplotlib inline
```
    


```python
#data folder
log_path = 'C:/Users/Roma Shusterman/Desktop/data/driving_log.csv'
data_folder = 'C:/Users/Roma Shusterman/Desktop/data/'

#resized image dimension in training
img_rows = 16
img_cols = 32

#batch size and epoch
batch_size = 64
epochs = 10
```


```python
# reading log file
logs = []
with open(log_path,'rt') as f:
    reader = csv.reader(f)
    for line in reader:
        logs.append(line)
```


```python
# image preprocessing, take only the S channel of HSV color space
fig = plt.figure(figsize = (14,6))
fig.subplots_adjust(left = 0, right = 1, bottom = 0, top = 0.5, hspace = 0.05, wspace = 0.05)
for i in range(4):

    img = plt.imread(data_folder + (logs[random.randint(1, 300)][0]).strip())
    img = img[60:140, :]
    img_processed = (cv2.cvtColor(cv2.resize(img,(32,16)), cv2.COLOR_RGB2HSV))[:,:,1]
    
    axis = fig.add_subplot(2, 4, i+1 , xticks=[], yticks=[])
    plt.imshow(img)
    
    axis = fig.add_subplot(2, 4, i+5, xticks=[], yticks=[])
    plt.imshow(img_processed,cmap='gray')

```


![png](output_3_0.png)



```python
def image_preprocessing(img):
    """preproccesing training data to keep only S channel in HSV color space, and resize to 16X32"""
    resized = cv2.resize((cv2.cvtColor(img, cv2.COLOR_RGB2HSV))[:,:,1],(img_cols,img_rows))
    return resized
```

**loading and preprocessing images**


```python
def load_data(X,y,data_folder,delta):
    log_path = data_folder + 'driving_log.csv'
    logs = []
    with open(log_path,'rt') as f:
        reader = csv.reader(f)
        for line in reader:
            logs.append(line)
    
    for i in range(len(logs)):
        for j in range(0,3):
            img_path = logs[i][j]
            img_path = data_folder+'IMG'+(img_path.split('IMG')[1]).strip()
            img = plt.imread(img_path)
            X.append(image_preprocessing(img))
            
            if j==0 :
                y.append(float(logs[i][3]))
            elif j==1 :
                y.append(float(logs[i][3]) + delta)
            else:
                y.append(float(logs[i][3]) - delta)
```


```python
data={}
data['features'] = []
data['labels'] = []

load_data(data['features'], data['labels'],data_folder,0.2)
```


```python
plt.plot(data['labels'][1:500:3])
```




    [<matplotlib.lines.Line2D at 0xda08da0>]




![png](output_8_1.png)



```python
X_train = np.array(data['features']).astype('float32')
y_train = np.array(data['labels']).astype('float32')

max_y = 0.85*max(y_train);
y_train = y_train[abs(y_train)<max_y]
X_train = X_train[abs(y_train)<max_y]

```

    C:\Users\Roma Shusterman\Anaconda3\envs\carnd-term1\lib\site-packages\ipykernel\__main__.py:6: VisibleDeprecationWarning: boolean index did not match indexed array along dimension 0; dimension is 24108 but corresponding boolean dimension is 24102
    

**Duplicate data amount by fliping**


```python
X_train = np.append(X_train, X_train[:,:,::-1],axis=0)
y_train = np.append(y_train,-y_train,axis=0)
```

**Splitting to training validation and test**


```python
X_train, y_train = shuffle(X_train, y_train)
X_train, X_val, y_train, y_val = train_test_split(X_train, y_train, random_state=0, test_size=0.1)
```

**reshape to the shape (None,16,32,1) **


```python
X_train = X_train.reshape(X_train.shape[0], img_rows, img_cols, 1)
X_val = X_val.reshape(X_val.shape[0], img_rows, img_cols, 1)
```

** Model: using two layer convolutional network **


```python
filter_size = (3,3)
pool_size = (2,2)

model = Sequential()

model.add(Lambda(lambda x: x/255. - 0.5,input_shape=(img_rows,img_cols,1)))
model.add(Convolution2D(32,filter_size, padding='valid', name='conv1', activation='relu'))
model.add(MaxPooling2D(pool_size=pool_size))
model.add(Dropout(0.25))

model.add(Convolution2D(64,filter_size, padding='valid', name='conv2', activation='relu'))
model.add(MaxPooling2D(pool_size=pool_size))
model.add(Dropout(0.25))

model.add(Flatten())
model.add(Dense(1))

model.summary()
```

    _________________________________________________________________
    Layer (type)                 Output Shape              Param #   
    =================================================================
    lambda_1 (Lambda)            (None, 16, 32, 1)         0         
    _________________________________________________________________
    conv1 (Conv2D)               (None, 14, 30, 32)        320       
    _________________________________________________________________
    max_pooling2d_1 (MaxPooling2 (None, 7, 15, 32)         0         
    _________________________________________________________________
    dropout_1 (Dropout)          (None, 7, 15, 32)         0         
    _________________________________________________________________
    conv2 (Conv2D)               (None, 5, 13, 64)         18496     
    _________________________________________________________________
    max_pooling2d_2 (MaxPooling2 (None, 2, 6, 64)          0         
    _________________________________________________________________
    dropout_2 (Dropout)          (None, 2, 6, 64)          0         
    _________________________________________________________________
    flatten_1 (Flatten)          (None, 768)               0         
    _________________________________________________________________
    dense_1 (Dense)              (None, 1)                 769       
    =================================================================
    Total params: 19,585.0
    Trainable params: 19,585.0
    Non-trainable params: 0.0
    _________________________________________________________________
    

**Train**


```python
model.compile(loss='mean_squared_error',optimizer='adam')
history = model.fit(X_train, y_train, batch_size=batch_size, epochs=epochs,verbose=1, validation_data=(X_val, y_val))

### plot the training and validation loss for each epoch
plt.plot(history.history['loss'])
plt.plot(history.history['val_loss'])
plt.title('model mean squared error loss')
plt.ylabel('mean squared error loss')
plt.xlabel('epoch')
plt.legend(['training set', 'validation set'], loc='upper right')
plt.show()
```

    Train on 43383 samples, validate on 4821 samples
    Epoch 1/10
    43383/43383 [==============================] - 15s - loss: 0.0220 - val_loss: 0.0185
    Epoch 2/10
    43383/43383 [==============================] - 13s - loss: 0.0186 - val_loss: 0.0176
    Epoch 3/10
    43383/43383 [==============================] - 13s - loss: 0.0179 - val_loss: 0.0170
    Epoch 4/10
    43383/43383 [==============================] - 14s - loss: 0.0173 - val_loss: 0.0165
    Epoch 5/10
    43383/43383 [==============================] - 14s - loss: 0.0169 - val_loss: 0.0162
    Epoch 6/10
    43383/43383 [==============================] - 14s - loss: 0.0165 - val_loss: 0.0157
    Epoch 7/10
    43383/43383 [==============================] - 14s - loss: 0.0161 - val_loss: 0.0153
    Epoch 8/10
    43383/43383 [==============================] - 14s - loss: 0.0156 - val_loss: 0.0160
    Epoch 9/10
    43383/43383 [==============================] - 14s - loss: 0.0154 - val_loss: 0.0146
    Epoch 10/10
    43383/43383 [==============================] - 14s - loss: 0.0151 - val_loss: 0.0140
    


![png](output_19_1.png)


**Save model**


```python
model.save("model.h5")
print("Model saved.")
```

    Model saved.
    
